trigger:
  branches:
    include:
      - main
      - master

pool:
  name: 'Default'  # Self-hosted agent pool

variables:
  acrName: 'orchestrationAgent'  # e.g., myappregistry
  acrLoginServer: '$(acrName).azurecr.io'
  imageName: 'chatgpt-web-ui'
  imageTag: '$(Build.BuildId)'
  dockerComposeFile: 'docker-compose.prod.yml'

stages:
  - stage: Build
    displayName: 'Build and Push Docker Image'
    jobs:
      - job: BuildJob
        displayName: 'Build Docker Image'
        steps:
          - task: Docker@2
            displayName: 'Build and Push Docker Image'
            inputs:
              command: buildAndPush
              containerRegistry: 'ACR-ServiceConnection'
              repository: '$(imageName)'
              Dockerfile: 'Dockerfile'
              tags: |
                $(imageTag)
                latest

  - stage: Deploy
    displayName: 'Deploy to Azure VM'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - job: DeployJob
        displayName: 'Deploy to Production VM'
        steps:
          - task: SSH@0
            displayName: 'Deploy via SSH'
            inputs:
              sshEndpoint: 'VM-SSH-ServiceConnection'  # You'll create this service connection
              runOptions: 'inline'
              inline: |
                # Login to ACR
                echo "Logging into Azure Container Registry..."
                sudo docker login $(acrLoginServer) -u $(ACR_USERNAME) -p $(ACR_PASSWORD)
                
                # Navigate to app directory
                cd /home/azureuser/app || mkdir -p /home/azureuser/app && cd /home/azureuser/app
                
                # Pull latest docker-compose file
                echo "Pulling latest configuration..."
                
                # Stop existing containers
                echo "Stopping existing containers..."
                sudo docker compose down || true
                
                # Pull latest images
                echo "Pulling latest Docker images..."
                sudo docker pull $(acrLoginServer)/$(imageName):latest
                
                # Start containers
                echo "Starting containers..."
                sudo docker compose up -d
                
                # Clean up old images
                echo "Cleaning up old images..."
                sudo docker image prune -f
                
                echo "Deployment completed successfully!"
              readyTimeout: '20000'
